name: Build & Deploy React (Staging & Production)

on:
  push:
    branches:
      - main
      - staging  # branch staging otomatis deploy ke server staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Tentukan environment berdasarkan branch
      ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      # 1. Checkout code
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3. Cache npm dependencies
      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. Install dependencies
      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # 5. Build React
      - name: Build React
        run: npm run build

      # 6. Upload build folder via rsync (hanya file berubah)
      #- name: Deploy to server via SSH
       # uses: appleboy/ssh-action@v0.1.7
       # with:
       #   host: ${ secrets.SERVER_HOST }}
        #  username: ${ secrets.SERVER_USER }}
        #  key: ${ secrets.SERVER_SSH_KEY }}
        #  port: ${ secrets.SERVER_PORT }}
        #  script: |
         #   echo "Deploying ${ENV} build..."
            # Backup current version (rollback)
         #   if [ -d /var/www/html/myapp ]; then
         #     mv /var/www/html/myapp /var/www/html/myapp_backup_$(date +%Y%m%d%H%M%S)
         #   fi
            # Copy build
        #    rsync -av --delete ./dist/ /var/www/html/myapp/
            # Restart server
        #    sudo systemctl restart nginx
